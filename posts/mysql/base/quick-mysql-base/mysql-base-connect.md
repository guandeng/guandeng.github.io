---
title: Mysql连接池工作原理
date: 2022-05-02
description: Mysql系列
tags:
- Mysql
nav: Mysql系列
categories:
- Mysql基础
keywords:
- Mysql系列
image: post/imgs/mysql查询流程.png
---
#### 工作流程
##### 请求
- 客户请求数据库连接，检查连接池是否有空闲连接
- 有空闲连接则分配给这个请求，没有空闲连接，检查是否达到最大连接数(max_connections)
- 没有达到最大连接数（max_connections），则创建一个连接给请求，达到最大连接数，进行最大超时等待（wait_timeout）
- 超过最大超时等待（wait_timeout），则抛出异常

##### 释放
- 请求释放数据库连接，判断引用次数是否超过规定值
- 超过规定值，则进行删除，没有超过则保留为其他请求服务，保证数据库连接有效复用


#### 关闭
- 应用程序退出，关闭连接池所有连接


#### 什么是引用计数
- 对释放策略对有效复用非常重要作用
- 被分配出去repeat
- 被释放回来remove
- 使用isRepeat确定连接使用引用计数
- 使用连接进行登记，增加引用计数，释放就减少引用计数
- 好处：根据策略，从池中挑出正在使用的连接来复用，而不是随便拿出一个连接复用


#### 连接池和线程池区别
##### 线程池工作原理
- 在5.6版才有，之前创建一个线程处理，处理销毁
- 启动若干数量线程，让线程出去睡眠状态
- 有新请求是，会唤醒一个线程池某个睡眠线程，来处理客户端请求
- 减少上下文切换和资源竞争，提高资源利用效率
- 池中总线程数是核心池线程数量两倍

#### 线程池优化
- 问题
    - A，B两个事务被分配到不同的group中执行，A事务已经开始，并且持有锁，但由于A所在的group比较繁忙，导致A执行一条语句后，不能立即获得调度执行；而B事务依赖A事务释放锁资源，虽然B事务可以被调度起来，但由于无法获得锁资源，导致仍然需要等待，这就是所谓的调度死锁
- 解决
    - 有的连接是第一次发送请求；而有的连接对应的事务已经开启，并且持有了部分锁资源。为了减少锁资源争用，后者显然应该比前者优先处理，以达到尽早释放锁资源的目的。因此在group里面，可以添加一个优先级队列，将已经持有锁的连接，或者已经开启的事务的连接发起的请求放入优先队列，工作线程首先从优先队列获取任务执行
- 优先任务队列（high_prio_queue）和普通任务队列（queue），优先队列中的IO任务会先被处理，然后普通队列中的任务才能够被处理
    - 连接处于事务中
    - 连接关联的priority tickets(thread_pool_high_prio_tickets每个连接的任务最多被放入优先队列n次)值大于0。[防止高优先级任务总被处理，每次放入时候减一，剪到0为止]
- Check Stall机制
    - 检查线程组的负载情况进行工作线程的唤醒与创建
    - 检查与处理超时的客户端连接。

参考
- https://my.oschina.net/andylucc/blog/820624